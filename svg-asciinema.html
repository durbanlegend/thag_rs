<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SVG Asciinema Recorder â€“ Flamegraph Demo</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #f9f9f9;
    font-family: sans-serif;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    padding: 20px;
  }

  #controls {
    display: flex;
    gap: 8px;
  }

  button {
    background: #007acc;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
  }
  button:hover { background: #005f99; }
  button:disabled { background: #ccc; cursor: default; }

  #timeline {
    width: 1200px;
    height: 174px;
    border: 1px solid #ccc;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
    background: white;
    overflow: hidden;
    position: relative;
  }

  #timeline object,
  #timeline svg {
    width: 100% !important;
    height: auto !important;
    display: block;
  }

  #script {
    width: 1200px;
    height: 120px;
    font-family: monospace;
    font-size: 13px;
    resize: vertical;
  }
</style>
</head>
<body>

  <div id="controls">
    <button id="record">Record</button>
    <button id="stop" disabled>Stop</button>
    <button id="play" disabled>Play</button>
  </div>

  <div id="timeline">
    <object id="svgobj" data="flamegraph.svg" type="image/svg+xml"></object>
  </div>

  <textarea id="script" placeholder="Recorded script will appear here..."></textarea>

  <script>
  const recordButton = document.getElementById('record');
  const stopButton = document.getElementById('stop');
  const playButton = document.getElementById('play');
  const scriptBox = document.getElementById('script');
  const svgObject = document.getElementById('svgobj');

  let recording = false;
  let startTime = 0;
  let recorded = [];

  svgObject.addEventListener('load', () => {
    const svgDoc = svgObject.contentDocument;

    function getBarLabel(target) {
      const parent = target.parentNode;
      const labelEl = parent.querySelector('text');
      return labelEl ? labelEl.textContent.trim() : '(unknown)';
    }

    function highlightBar(rect, color='orange', duration=600) {
      const original = rect.getAttribute('fill');
      rect.setAttribute('fill', color);
      setTimeout(() => rect.setAttribute('fill', original), duration);
    }

    function findBarByLabel(label) {
      return Array.from(svgDoc.querySelectorAll('rect')).find(r => {
        const t = r.parentNode.querySelector('text');
        return t && t.textContent.trim() === label;
      });
    }

    // --- Recording setup ---
    svgDoc.addEventListener('mouseover', e => {
      if (!recording || e.target.tagName !== 'rect') return;
      recorded.push({
        type: 'hover',
        label: getBarLabel(e.target),
        time: performance.now() - startTime
      });
    });
    svgDoc.addEventListener('click', e => {
      if (!recording || e.target.tagName !== 'rect') return;
      recorded.push({
        type: 'click',
        label: getBarLabel(e.target),
        time: performance.now() - startTime
      });
    });

    recordButton.onclick = () => {
      recorded = [];
      recording = true;
      startTime = performance.now();
      recordButton.disabled = true;
      stopButton.disabled = false;
      playButton.disabled = true;
      scriptBox.value = 'Recording...';
    };

    stopButton.onclick = () => {
      recording = false;
      recordButton.disabled = false;
      stopButton.disabled = true;
      playButton.disabled = false;
      scriptBox.value = JSON.stringify(recorded, null, 2);
    };

    playButton.onclick = async () => {
      playButton.disabled = true;
      const script = JSON.parse(scriptBox.value || '[]');
      let prevTime = 0;
      for (const evt of script) {
        const delay = evt.time - prevTime;
        prevTime = evt.time;
        await new Promise(r => setTimeout(r, delay));
        const rect = findBarByLabel(evt.label);
        if (rect) {
          highlightBar(rect, evt.type === 'click' ? 'red' : 'orange');
        }
      }
      playButton.disabled = false;
    };
  });
  </script>
</body>
</html>
